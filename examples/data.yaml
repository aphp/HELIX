
configuration:
  jupyterhub:

    profiles:
      user: 
        - displayName: "Jupyter EDS Base Notebook"
          slug: "eds-base-dev"
          image: "aphp/jupyterlab:eds-base-notebook_ubuntu-22.04"
          imagePullPolicy: "Always"
        - displayName: "Jupyter EDS OCAML Notebook"
          slug: "eds-ocaml-dev"
          image: "aphp/jupyterlab:eds-ocaml-notebook_ubuntu-22.04"
          imagePullPolicy: "Always"
        - displayName: "Jupyter Minimal Notebook"
          slug: "minimal"
          image: "quay.io/jupyter/minimal-notebook:latest"
          imagePullPolicy: "Always"
        - displayName: "Jupyter Datascience Notebook"
          slug: "datascience"
          image: "quay.io/jupyter/datascience-notebook:latest"
          imagePullPolicy: "Always"

      collaboration:

        - displayName: "Jupyter EDS Base Notebook"
          slug: "eds-base-dev"
          image: "aphp/jupyterlab:eds-base-notebook_ubuntu-22.04"
          imagePullPolicy: "Always"
        - displayName: "Jupyter EDS OCAML Notebook"
          slug: "eds-ocaml-dev"
          image: "aphp/jupyterlab:eds-ocaml-notebook_ubuntu-22.04"
          imagePullPolicy: "Always"

persistence:
  createPVC:
  - name: data-hdd-pvc
    storageClassName: "csi-cephfs-hdd-sc"
    accessMode: "ReadWriteOnce"
    size: "5Gi"
  - name: data-ssd-pvc 
    storageClassName: "csi-cephfs-sc"
    accessMode: "ReadWriteOnce"
    size: "5Gi"

serviceAccount:
  create: true
  automount: true
  annotations: {}
  name: ""

jupyterhub:
  enabled: true
  debug:
    enabled: false

  ingress:
    enabled: true
    ingressClassName: nginx
    hosts:
    - <project>-helix.eds.aphp.fr

  hub:
    baseUrl: /jupyter
    db:
      type: sqlite-pvc
      upgrade:
      pvc:
        annotations: {}
        selector: {}
        accessModes:
          - ReadWriteMany
        storage: 20Gi
        storageClassName: csi-cephfs-sc

    extraEnv:
      COLLAB_USER_NAME: "jhub-next-<project>-collab"
      JHUB_DEFAULT_URL: "/jupyter/hub/spawn/jhub-next-preprod-collab"
      OIDC_AUTHORIZE_URL: "https://auth.eds.aphp.fr/auth/realms/ID-Interne/protocol/openid-connect/auth"
      OIDC_CALLBACK_URL: "https://preprod-helix.eds.aphp.fr/jupyter/hub/oauth_callback"
      OIDC_TOKEN_URL: "https://auth.eds.aphp.fr/auth/realms/ID-Interne/protocol/openid-connect/token"
      OIDC_USERDATA_URL: "https://auth.eds.aphp.fr/auth/realms/ID-Interne/protocol/openid-connect/userinfo"
      OIDC_REQUESTED_SCOPES: "openid"
      OIDC_USERNAME_CLAIM: "name"
      OIDC_CLAIM_GROUPS_KEY: "groups"
      OIDC_ALLOWED_GROUPS: "/BBS_DA-N-<project>"
      OIDC_ADMIN_GROUPS: "/BBS_DA-N-<project>"
      OIDC_CLIENT_ID:
        valueFrom:
          secretKeyRef:
            name: "oidc-helix-preprod"
            key: "client-id"

      OIDC_CLIENT_SECRET: 
        valueFrom:
          secretKeyRef:
            name: "oidc-helix-preprod"
            key: "client-secret"

    redirectToServer: false

    extraFiles:
      collaboration_code-py:
        mountPath: "/usr/local/etc/jupyterhub/jupyterhub_config.d/00-collaboration.py"
      oauth_authenticator_config-py:
        mountPath: "/usr/local/etc/jupyterhub/jupyterhub_config.d/01-oauth_authenticator_config.py"
      custom_forms_code-py:
        mountPath: "/usr/local/etc/jupyterhub/jupyterhub_config.d/02-custom_forms.py"

  scheduling:
    userScheduler:
      enabled: false
    podPriority:
      enabled: false
    userPlaceholder:
      enabled: false

  proxy:
    service:
      type: ClusterIP

  prePuller:
    continuous:
      enabled: false
    hook:
      enabled: false

  cull:
    enabled: true
    timeout: 3600
    every: 300

  singleuser:
    podNameTemplate: "jupyter-{unescaped_username}"
    extraLabels:
      app.kubernetes.io/instance: id-pfm-helix-<project>

    extraEnv:
      PYDEVD_DISABLE_FILE_VALIDATION: "1"

      HADOOP_CONF_DIR: "/home/jovyan/.config/external/web-hdfs"
      KRB5_CONFIG: "/home/jovyan/.config/external/web-hdfs/kerberos/krb5.conf"
      KRB5CCNAME: "FILE:/krb5_ccache/krb5cc_hdfs"

      RCLONE_CONFIG_S3_TYPE: "s3"
      RCLONE_CONFIG_S3_PROVIDER: "Ceph"
      RCLONE_CONFIG_S3_ENDPOINT: "https://s3-ceph.eds.aphp.fr"
      RCLONE_CONFIG_S3_ACCESS_KEY_ID:
        valueFrom:
          secretKeyRef:
            name: "s3-data"
            key: "access_key"
      RCLONE_CONFIG_S3_SECRET_ACCESS_KEY:
        valueFrom:
          secretKeyRef:
            name: "s3-data"
            key: "secret_key"
      RCLONE_CONFIG_S3_BUCKET_HDD:
        valueFrom:
          secretKeyRef:
            name: "s3-data"
            key: "bucket_hdd"
      RCLONE_CONFIG_S3_BUCKET_SSD:
        valueFrom:
          secretKeyRef:
            name: "s3-data"
            key: "bucket_ssd"
      AWS_ENDPOINT_URL: "https://s3-ceph.eds.aphp.fr"
      AWS_ACCESS_KEY_ID:
        valueFrom:
          secretKeyRef:
            name: "s3-data"
            key: "access_key"
      AWS_SECRET_ACCESS_KEY:
        valueFrom:
          secretKeyRef:
            name: "s3-data"
            key: "secret_key"

    storage:
      dynamic:
        storageClass: csi-cephfs-sc
        storageAccessModes:
        - ReadWriteMany
      capacity: 20Gi

      extraVolumeMounts:
      - mountPath: /home/jovyan/.config/external
        name: <project>-collab-conf
      - mountPath: /data/ssd
        name: <project>-collab-data-ssd
      - mountPath: /data/hdd
        name: <project>-collab-data-hdd
      - mountPath: /krb5_ccache
        name: krb5-cache

      extraVolumes:
      - name: <project>-collab-conf
        persistentVolumeClaim:
          claimName: <project>-collab-conf-pvc 
      - name: <project>-collab-data-hdd
        persistentVolumeClaim:
          claimName: <project>-collab-data-hdd-pvc
      - name: <project>-collab-data-ssd
        persistentVolumeClaim:
          claimName: <project>-collab-data-ssd-pvc
      - name: keytab
        secret:
          secretName: keytab
      - name: krb5-cache
        emptyDir: {}

    lifecycleHooks:
      postStart:
        exec:
          command:
          - "sh"
          - "-c"
          - "if [ -d /tmp/home ]; then cp -rf /tmp/home/.[^.]* /home/jovyan/; fi"

    cpu:
      limit: 4
      guarantee: 1
    memory:
      limit: 16G
      guarantee: 4G